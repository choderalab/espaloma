<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Getting Started &mdash; espaloma  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="API Documentation" href="api.html" />
    <link rel="prev" title="MALT: Molecular Active Learning Testbed" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> espaloma
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#paper-abstract">Paper Abstract</a></li>
<li class="toctree-l2"><a class="reference internal" href="#minimal-example">Minimal Example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">espaloma</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Getting Started</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/getting_started.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="getting-started">
<h1>Getting Started<a class="headerlink" href="#getting-started" title="Permalink to this headline"></a></h1>
<img alt="_images/espaloma_abstract_v2-2.png" src="_images/espaloma_abstract_v2-2.png" />
<section id="paper-abstract">
<h2>Paper Abstract<a class="headerlink" href="#paper-abstract" title="Permalink to this headline"></a></h2>
<p>Molecular mechanics (MM) potentials have long been a workhorse of computational chemistry.
Leveraging accuracy and speed, these functional forms find use in a wide variety of applications in biomolecular modeling and drug discovery, from rapid virtual screening to detailed free energy calculations.
Traditionally, MM potentials have relied on human-curated, inflexible, and poorly extensible discrete chemical perception rules _atom <a href="#id1"><span class="problematic" id="id2">types_</span></a> for applying parameters to small molecules or biopolymers, making it difficult to optimize both types and parameters to fit quantum chemical or physical property data.
Here, we propose an alternative approach that uses _graph neural <a href="#id3"><span class="problematic" id="id4">networks_</span></a> to perceive chemical environments, producing continuous atom embeddings from which valence and nonbonded parameters can be predicted using invariance-preserving layers.
Since all stages are built from smooth neural functions, the entire process—spanning chemical perception to parameter assignment—is modular and end-to-end differentiable with respect to model parameters, allowing new force fields to be easily constructed, extended, and applied to arbitrary molecules.
We show that this approach is not only sufficiently expressive to reproduce legacy atom types, but that it can learn and extend existing molecular mechanics force fields, construct entirely new force fields applicable to both biopolymers and small molecules from quantum chemical calculations, and even learn to accurately predict free energies from experimental observables.</p>
</section>
<section id="minimal-example">
<h2>Minimal Example<a class="headerlink" href="#minimal-example" title="Permalink to this headline"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span><span class="o">,</span> <span class="nn">dgl</span><span class="o">,</span> <span class="nn">espaloma</span> <span class="k">as</span> <span class="nn">esp</span>

<span class="c1"># retrieve QM dataset used to train OpenFF 1.0.0 (&quot;parsley&quot;) small molecule force field</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">esp</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">GraphDataset</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;parsley&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>

<span class="c1"># define Espaloma stage I: graph -&gt; atom latent representation</span>
<span class="n">representation</span> <span class="o">=</span> <span class="n">esp</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
    <span class="n">layer</span><span class="o">=</span><span class="n">esp</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">dgl_legacy</span><span class="o">.</span><span class="n">gn</span><span class="p">(</span><span class="s2">&quot;SAGEConv&quot;</span><span class="p">),</span> <span class="c1"># use SAGEConv implementation in DGL</span>
    <span class="n">config</span><span class="o">=</span><span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="s2">&quot;relu&quot;</span><span class="p">],</span> <span class="c1"># 3 layers, 128 units, ReLU activation</span>
<span class="p">)</span>

<span class="c1"># define Espaloma stage II and III:</span>
<span class="c1"># atom latent representation -&gt; bond, angle, and torsion representation and parameters</span>
<span class="n">readout</span> <span class="o">=</span> <span class="n">esp</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">readout</span><span class="o">.</span><span class="n">janossy</span><span class="o">.</span><span class="n">JanossyPooling</span><span class="p">(</span>
    <span class="n">in_features</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
    <span class="n">config</span><span class="o">=</span><span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="s2">&quot;relu&quot;</span><span class="p">],</span>
    <span class="n">out_features</span><span class="o">=</span><span class="p">{</span>              <span class="c1"># define modular MM parameters Espaloma will assign</span>
        <span class="mi">1</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;e&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
        <span class="mi">2</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;coefficients&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span> <span class="c1"># bond linear combination</span>
        <span class="mi">3</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;coefficients&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span> <span class="c1"># angle linear combination</span>
        <span class="mi">4</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">},</span> <span class="c1"># torsion barrier heights (can be positive or negative)</span>
    <span class="p">},</span>
<span class="p">)</span>

<span class="c1"># compose all three Espaloma stages into an end-to-end model</span>
<span class="n">espaloma_model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
                 <span class="n">representation</span><span class="p">,</span>
                 <span class="n">readout</span><span class="p">,</span>
                 <span class="n">esp</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">GeometryInGraph</span><span class="p">(),</span>
                 <span class="n">esp</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">EnergyInGraph</span><span class="p">(),</span>
                 <span class="n">esp</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">readout</span><span class="o">.</span><span class="n">charge_equilibrium</span><span class="o">.</span><span class="n">ChargeEquilibrium</span><span class="p">(),</span>
<span class="p">)</span>

<span class="c1"># define training metric</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">esp</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">GraphMetric</span><span class="p">(</span>
            <span class="n">base_metric</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">(),</span> <span class="c1"># use mean-squared error loss</span>
            <span class="n">between</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s2">&quot;u_ref&quot;</span><span class="p">],</span>         <span class="c1"># between predicted and QM energies</span>
            <span class="n">level</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">esp</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">GraphMetric</span><span class="p">(</span>
            <span class="n">base_metric</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">(),</span> <span class="c1"># use mean-squared error loss</span>
            <span class="n">between</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s2">&quot;q_hat&quot;</span><span class="p">],</span>         <span class="c1"># between predicted and reference charges</span>
            <span class="n">level</span><span class="o">=</span><span class="s2">&quot;n1&quot;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">]</span>

<span class="c1"># fit Espaloma model to training data</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">esp</span><span class="o">.</span><span class="n">Train</span><span class="p">(</span>
    <span class="n">ds_tr</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span> <span class="n">net</span><span class="o">=</span><span class="n">espaloma_model</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span>
    <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:0&#39;</span><span class="p">),</span> <span class="n">n_epochs</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
    <span class="n">optimizer</span><span class="o">=</span><span class="k">lambda</span> <span class="n">net</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="mf">1e-3</span><span class="p">),</span> <span class="c1"># use Adam optimizer</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="MALT: Molecular Active Learning Testbed" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="api.html" class="btn btn-neutral float-right" title="API Documentation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Yuanqing Wang @ choderalab // MSKCC..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>