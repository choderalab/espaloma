<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quantum mechanics (QM) fitting experiment. &mdash; espaloma  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> espaloma
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy.html">Deploy espaloma 0.2.0 force field to parametrize your MM system</a></li>
<li class="toctree-l1"><a class="reference internal" href="experiments/typing.html">Atom typing recovery experiment.</a></li>
<li class="toctree-l1"><a class="reference internal" href="experiments/mm_fitting_small.html">Toy experiment: Molecular mechanics (MM) fitting on subsampled PhAlkEthOH dataset.</a></li>
<li class="toctree-l1"><a class="reference internal" href="experiments/qm_fitting.html">Quantum mechanics (QM) fitting experiment.</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">espaloma</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Quantum mechanics (QM) fitting experiment.</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/qm_fitting.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="quantum-mechanics-qm-fitting-experiment">
<h1>Quantum mechanics (QM) fitting experiment.<a class="headerlink" href="#quantum-mechanics-qm-fitting-experiment" title="Permalink to this headline"></a></h1>
<p><strong>Open in Google Colab:</strong>
<a class="reference external" href="http://data.wangyq.net/esp_notesbooks/qm_fitting.ipynb">http://data.wangyq.net/esp_notesbooks/qm_fitting.ipynb</a></p>
<p>This notebook recovers the QM fitting experiment in
<a class="reference external" href="https://arxiv.org/abs/2010.01196">https://arxiv.org/abs/2010.01196</a></p>
<p><img alt="image1" src="https://pbs.twimg.com/media/FBL1Gb0WEAYkUhM?format=png&amp;name=4096x4096" /> <strong>Table 2:</strong> Espaloma can directly fit quantum chemical
energies to produce a new molecular mechanics force fields with better
accuracy than traditional force fields based on atom typing or direct
chemical perception. Espaloma was fit to quantum chemical potential
energies for conformations generated by optimization trajectories from
multiple conformers in various datasets from QCArchive.All datasets were
partitioned by molecules 80:10:10 into train:validate:test sets. We
report the RMSE on training and test sets, as well as the performance of
legacy force fields on the test set. All statistics are computed with
predicted and reference energies centered to have zero mean for each
molecule to focus on errors in relative conformational energetics,
rather than on errors in predicting the heats of formation of chemical
species (which the MM functional form used here is incapable of). The
95% confidence intervals annotated are calculated by via bootstrapping
molecules with replacement using 1000 replicates. *: Six cyclic
peptides that cannot be parametrized using OpenForceField toolkit
engine~:raw-latex:<cite>cite{openff-toolkit-0.10.0}</cite> and is not included.</p>
<p>Since Espaloma can derive a force field solely by fitting to energies
(and optionally gradients), we repeat the end-to-end fitting experiment
(See notebook
<a class="reference external" href="http://data.wangyq.net/esp_notebooks/phalkethoh_mm_small.ipynb">http://data.wangyq.net/esp_notebooks/phalkethoh_mm_small.ipynb</a>) directly
using a quantum chemical (QM) datasets used to build and evaluate MM
force fields. We assessed the ability of Espaloma to learn several
distinct quantum chemical datasets generated by the Open Force Field
Initiativeand deposited in the MolSSI QCArchive: - <strong>PhAlkEthOH</strong> is a
collection of compounds containing only the elements carbon, hydrogen,
and oxygen in compounds containing phenyl rings, alkanes, ketones, and
alcohols. Limited in elemental and chemical diversity, this dataset is
chosen as a proof-of-concept to demonstrate the capability of Espaloma
to fit and generalize quantum chemical energies when training data is
sufficient to exhaustively cover the breadth of chemical environments. -
<strong>OpenFF Gen2 Optimization</strong> consists of druglike molecules used in the
parametrization of the Open Force Field 1.2.0 (“Parsley”) small molecule
force field. This set was constructed by the Open Force Field Consortium
from challenging molecule structures provided by Pfizer, Bayer, and
Roche, along with diverse molecules selected from eMolecules to achieve
useful coverage of chemical space. - <strong>VEHICLe</strong>, or <em>virtual
exploratory heterocyclic library</em>, is a set of heteroaromatic ring
systems of interest to drug discovery. The atoms in the molecules in
this dataset have interesting chemical environments in heteroarmatic
rings that present a challenge to traditional atom typing schemes, which
cannot easily accomodate the nuanced distinctions in chemical
environments that lead to perturbations in heterocycle structure.We use
this dataset to illustrate that Espaloma performs in situations
challenging to traditional force fields. - <strong>PepConf</strong> contains a
variety of short peptides, including capped, cyclic, and
disulfide-bonded peptides.This dataset—regenerated using the Open Force
Field QCSubmit tool—explores the applicability of Espaloma to
biopolymers, such as proteins.</p>
<p>Since nonbonded terms are generally optimized to fit other
condensed-phase properties, we focused here on optimizing only the
valence parameters (bond, angle, and proper and improper torsion) to fit
these gas-phase quantum chemical datasets, fixing the non-bonded
energies using a legacy force field. Because we are learning an MM force
field that is incapable of reproducing quantum chemical heats of
formation reflected as an additive offset in the quantum chemical energy
targets, in both training and test sets, snapshot energies for each
molecule are shifted to have zero mean. All datasets are randomly
shuffled and split (by molecules) into training (80%), validation (10%),
and test (10%) sets.</p>
<section id="installation-and-imports">
<h2>Installation and imports<a class="headerlink" href="#installation-and-imports" title="Permalink to this headline"></a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span># install conda
! pip install -q condacolab
import condacolab
condacolab.install()
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>%%capture
! mamba install --yes --strict-channel-priority --channel jaimergp/label/unsupported-cudatoolkit-shim --channel omnia --channel omnia/label/cuda100 --channel dglteam --channel numpy openmm openmmtools openmmforcefields rdkit openff-toolkit dgl-cuda10.0 qcportal
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>! git clone https://github.com/choderalab/espaloma.git
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;/content/espaloma&quot;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">espaloma</span> <span class="k">as</span> <span class="nn">esp</span>
</pre></div>
</div>
</section>
<section id="load-dataset">
<h2>Load dataset<a class="headerlink" href="#load-dataset" title="Permalink to this headline"></a></h2>
<p>Choose a dataset from <code class="docutils literal notranslate"><span class="pre">[&quot;gen2&quot;,</span> <span class="pre">&quot;pepconf&quot;,</span> <span class="pre">&quot;vehicle&quot;,</span> <span class="pre">&quot;phalkethoh&quot;]</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dataset_name</span> <span class="o">=</span> <span class="s2">&quot;gen2&quot;</span>
<span class="c1"># dataset_name = &quot;pepconf&quot;</span>
<span class="c1"># dataset_name = &quot;vehicle&quot;</span>
<span class="c1"># dataset_name = &quot;phalkethoh&quot;</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>%%capture
! wget &quot;data.wangyq.net/esp_dataset/&quot;$dataset_name&quot;.zip&quot;
! unzip $dataset_name&quot;.zip&quot;
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span> <span class="o">=</span> <span class="n">esp</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">GraphDataset</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">)</span>
<span class="n">ds</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">2666</span><span class="p">)</span>
<span class="n">ds_tr</span><span class="p">,</span> <span class="n">ds_vl</span><span class="p">,</span> <span class="n">ds_te</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">split</span><span class="p">([</span><span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</section>
<section id="define-model">
<h2>Define model<a class="headerlink" href="#define-model" title="Permalink to this headline"></a></h2>
<p>Define Espaloma stage I: graph -&gt; atom latent representation</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">representation</span> <span class="o">=</span> <span class="n">esp</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
    <span class="n">layer</span><span class="o">=</span><span class="n">esp</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">dgl_legacy</span><span class="o">.</span><span class="n">gn</span><span class="p">(</span><span class="s2">&quot;SAGEConv&quot;</span><span class="p">),</span> <span class="c1"># use SAGEConv implementation in DGL</span>
    <span class="n">config</span><span class="o">=</span><span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="s2">&quot;relu&quot;</span><span class="p">],</span> <span class="c1"># 3 layers, 128 units, ReLU activation</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Define Espaloma stage II and III: atom latent representation -&gt; bond,
angle, and torsion representation and parameters. And compose all three
Espaloma stages into an end-to-end model.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">readout</span> <span class="o">=</span> <span class="n">esp</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">readout</span><span class="o">.</span><span class="n">janossy</span><span class="o">.</span><span class="n">JanossyPooling</span><span class="p">(</span>
    <span class="n">in_features</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="s2">&quot;relu&quot;</span><span class="p">],</span>
    <span class="n">out_features</span><span class="o">=</span><span class="p">{</span>              <span class="c1"># define modular MM parameters Espaloma will assign</span>
        <span class="mi">1</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;e&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="c1"># atom hardness and electronegativity</span>
        <span class="mi">2</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;log_coefficients&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span> <span class="c1"># bond linear combination, enforce positive</span>
        <span class="mi">3</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;log_coefficients&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span> <span class="c1"># angle linear combination, enforce positive</span>
        <span class="mi">4</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">},</span> <span class="c1"># torsion barrier heights (can be positive or negative)</span>
    <span class="p">},</span>
<span class="p">)</span>

<span class="n">espaloma_model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
                 <span class="n">representation</span><span class="p">,</span> <span class="n">readout</span><span class="p">,</span> <span class="n">esp</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">readout</span><span class="o">.</span><span class="n">janossy</span><span class="o">.</span><span class="n">ExpCoefficients</span><span class="p">(),</span>
                 <span class="n">esp</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">GeometryInGraph</span><span class="p">(),</span>
                 <span class="n">esp</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">EnergyInGraph</span><span class="p">(),</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
    <span class="n">espaloma_model</span> <span class="o">=</span> <span class="n">espaloma_model</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
</pre></div>
</div>
<p>Loss function is specified as the MSE between predicted and reference
energy.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">loss_fn</span> <span class="o">=</span> <span class="n">esp</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">GraphMetric</span><span class="p">(</span>
        <span class="n">base_metric</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">(),</span> <span class="c1"># use mean-squared error loss</span>
        <span class="n">between</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s2">&quot;u_ref&quot;</span><span class="p">],</span>         <span class="c1"># between predicted and QM energies</span>
        <span class="n">level</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="c1"># compare on graph level</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="define-optimizer">
<h2>Define optimizer<a class="headerlink" href="#define-optimizer" title="Permalink to this headline"></a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">espaloma_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="mf">1e-4</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="train-it">
<h2>Train it!<a class="headerlink" href="#train-it" title="Permalink to this headline"></a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">idx_epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">ds_tr</span><span class="p">:</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
            <span class="n">g</span><span class="o">.</span><span class="n">heterograph</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">heterograph</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cuda:0&quot;</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">espaloma_model</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">heterograph</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">espaloma_model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.th&quot;</span> <span class="o">%</span> <span class="n">idx_epoch</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="inspect">
<h2>Inspect<a class="headerlink" href="#inspect" title="Permalink to this headline"></a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">inspect_metric</span> <span class="o">=</span> <span class="n">esp</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">L1Loss</span><span class="p">())</span> <span class="c1"># use mean-squared error loss</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">loss_tr</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">loss_vl</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">idx_epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">):</span>
        <span class="n">espaloma_model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.th&quot;</span> <span class="o">%</span> <span class="n">idx_epoch</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># training set performance</span>
        <span class="n">u</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">u_ref</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">ds_tr</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
                <span class="n">g</span><span class="o">.</span><span class="n">heterograph</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">heterograph</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cuda:0&quot;</span><span class="p">)</span>
            <span class="n">espaloma_model</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">heterograph</span><span class="p">)</span>
            <span class="n">u</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">])</span>
            <span class="n">u_ref</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">])</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">u_ref</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">u_ref</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">loss_tr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inspect_metric</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">u_ref</span><span class="p">))</span>


        <span class="c1"># validation set performance</span>
        <span class="n">u</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">u_ref</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">ds_vl</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
                <span class="n">g</span><span class="o">.</span><span class="n">heterograph</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">heterograph</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cuda:0&quot;</span><span class="p">)</span>
            <span class="n">espaloma_model</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">heterograph</span><span class="p">)</span>
            <span class="n">u</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">])</span>
            <span class="n">u_ref</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">])</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">u_ref</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">u_ref</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">loss_vl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inspect_metric</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">u_ref</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">loss_tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">loss_tr</span><span class="p">)</span> <span class="o">*</span> <span class="mf">627.5</span>
<span class="n">loss_vl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">loss_vl</span><span class="p">)</span> <span class="o">*</span> <span class="mf">627.5</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">loss_tr</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">loss_vl</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Yuanqing Wang @ choderalab // MSKCC..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>